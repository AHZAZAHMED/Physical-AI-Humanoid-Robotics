# Data Model: Agent-based RAG Reasoning Flow

## Core Entities

### Query
Represents a user's input query and associated parameters.

**Fields**:
- `id` (string): Unique identifier for the query
- `text` (string): The original user query text
- `embedding` (array[float]): 1536-dimensional vector embedding of the query
- `parameters` (object): Configuration parameters for retrieval
  - `top_k` (integer): Number of top results to retrieve (default: 5)
  - `confidence_threshold` (float): Minimum similarity score (default: 0.7)
  - `include_metadata` (boolean): Whether to include metadata in results (default: true)
- `timestamp` (datetime): When the query was processed
- `user_id` (string, optional): Identifier for the user making the query

**Validation Rules**:
- `text` must be non-empty and less than 1000 characters
- `top_k` must be between 1 and 20
- `confidence_threshold` must be between 0.0 and 1.0
- `embedding` must have exactly 1536 dimensions

### RetrievedChunk
Represents a book content chunk retrieved from the vector database.

**Fields**:
- `id` (string): Unique identifier for the chunk
- `content` (string): The actual text content from the book
- `similarity_score` (float): Cosine similarity score to the query (0.0 to 1.0)
- `confidence_score` (float): Confidence in relevance after filtering (0.0 to 1.0)
- `metadata` (object): Information about the source
  - `book_title` (string): Title of the book
  - `chapter` (string): Chapter name or number
  - `section` (string): Section name or number
  - `page` (integer): Page number in the book
  - `content_type` (string): Type of content (e.g., "concept", "example", "exercise")
  - `difficulty_level` (string): Difficulty (e.g., "beginner", "intermediate", "advanced")
- `vector_id` (string): ID in the vector database
- `embedding` (array[float]): 1536-dimensional vector of the content

**Validation Rules**:
- `content` must be non-empty
- `similarity_score` must be between 0.0 and 1.0
- `confidence_score` must be between 0.0 and 1.0
- `metadata` must contain required fields (book_title, chapter, section)

### GeneratedResponse
Represents the final response generated by the OpenAI agent.

**Fields**:
- `id` (string): Unique identifier for the response
- `query_id` (string): Reference to the original query
- `text` (string): The generated response text
- `sources` (array[object]): List of retrieved chunks used in the response
  - `chunk_id` (string): ID of the retrieved chunk
  - `content_preview` (string): First 200 characters of the chunk
  - `similarity_score` (float): Similarity score to the original query
  - `source_metadata` (object): Metadata from the chunk
- `grounding_confidence` (float): Confidence that response is based on provided context (0.0 to 1.0)
- `response_time_ms` (integer): Time taken to generate the response
- `timestamp` (datetime): When the response was generated
- `response_style` (string): Style of the response (e.g., "educational", "technical", "practical")

**Validation Rules**:
- `text` must be non-empty
- `grounding_confidence` must be between 0.0 and 1.0
- `response_time_ms` must be positive
- `sources` array must not exceed 10 items

### AgentConfiguration
Represents the configuration for the RAG agent system.

**Fields**:
- `id` (string): Configuration identifier
- `default_top_k` (integer): Default number of results to retrieve (default: 5)
- `default_confidence_threshold` (float): Default minimum similarity score (default: 0.7)
- `max_query_length` (integer): Maximum length of input queries (default: 1000)
- `max_context_length` (integer): Maximum tokens in context for agent (default: 2000)
- `agent_model` (string): OpenAI model to use (default: "gpt-4-turbo")
- `embedding_model` (string): Embedding model to use (default: "text-embedding-ada-002")
- `max_retries` (integer): Maximum retries for API calls (default: 3)
- `timeout_seconds` (integer): Timeout for API calls (default: 30)

**Validation Rules**:
- `default_top_k` must be between 1 and 20
- `default_confidence_threshold` must be between 0.0 and 1.0
- `max_query_length` must be between 100 and 5000
- `agent_model` must be a valid OpenAI model
- `max_retries` must be between 1 and 10

## Relationships

### Query to RetrievedChunk
- One query can result in multiple retrieved chunks (one-to-many)
- Relationship: `query.id` → `retrieved_chunk.query_id`

### RetrievedChunk to GeneratedResponse
- One generated response can reference multiple retrieved chunks (many-to-many through sources array)
- Relationship: `generated_response.sources[].chunk_id` → `retrieved_chunk.id`

### Query to GeneratedResponse
- One query generates one response (one-to-one)
- Relationship: `generated_response.query_id` → `query.id`

## State Transitions

### Query Processing States
- `PENDING`: Query received, waiting for processing
- `EMBEDDING`: Query being converted to embedding
- `SEARCHING`: Performing vector search in Qdrant
- `FILTERING`: Filtering retrieved results by confidence
- `GENERATING`: OpenAI agent generating response
- `VALIDATING`: Validating response grounding
- `COMPLETED`: Response generated and ready for delivery
- `FAILED`: Processing failed at some stage

### Response Validation States
- `UNVALIDATED`: Response generated but not yet validated
- `GROUNDED`: Response confirmed to be based on provided context
- `UNGROUNDABLE`: Response not sufficiently based on provided context
- `VALIDATION_ERROR`: Error during validation process

## Indexes and Performance Considerations

### Vector Database Indexes
- Vector index on embedding fields for fast similarity search
- Composite index on metadata fields for efficient filtering
- Index on similarity_score for threshold-based queries

### API Performance
- Cache frequently requested queries and responses
- Implement pagination for large result sets
- Use async processing for long-running operations